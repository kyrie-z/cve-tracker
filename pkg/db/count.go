package db

import (
	"cve-tracker/pkg/utils"
	"strings"
)

//Query the number of vulnerabilities based on different query types and keywords
func QueryCount(sort, key, product string) *[7]int {
	db := getHandle(product)
	if db == nil {
		return nil
	}

	cveDB := db.Table("cve")
	kernelDB := db.Table("kernel")
	var count = [7]int{0}
	if sort == "high" { //高危漏洞
		cveDB.Where("score >= 7 and score <= 10 and status = ?", key).Count(&count[0])    //系统
		kernelDB.Where("score >= 7 and score <= 10 and status = ?", key).Count(&count[1]) //内核
	} else if sort == "medium" {
		cveDB.Where("score >= 4 and score <= 6.9 and status = ?", key).Count(&count[0])
		kernelDB.Where("score >= 4 and score <= 6.9 and status = ?", key).Count(&count[1])
	} else if sort == "low" {
		cveDB.Where("score >= 0 and score <= 3.9 and status = ?", key).Count(&count[0])
		kernelDB.Where("score >= 0 and score <= 3.9 and status = ?", key).Count(&count[1])
	} else if strings.Contains(sort, "daily") {
		daily := utils.WeekDone()
		for j, v := range daily {
			if v != "" {
				if sort == "sys_daily" { //系统每日修复
					cveDB.Where("fix_at = ?", v).Count(&count[j])
				}
				if sort == "kernel_daily" {
					kernelDB.Where("`release` = 4.19  and fix_at = ?", v).Count(&count[j])
				}
				if sort == "sys_new_daily" { //系统每日新增
					cveDB.Where("`created_at` BETWEEN ? AND ?", v+" 00:00:00", v+" 23:59:59").Count(&count[j])

				}
				if sort == "kernel_new_daily" {
					kernelDB.Where("`release` = 4.19  and `created_at` BETWEEN ? AND ?", v+" 00:00:00", v+" 23:59:59").Count(&count[j])
				}
			}
		}
	} else if strings.Contains(sort, "week") {
		if strings.Contains(sort, "this") {
			curMon, curNow := utils.WeekDate(0)                                                                                           //本周
			cveDB.Where("`created_at` BETWEEN ? AND ?", curMon+" 00:00:00", curNow+" 23:59:59").Count(&count[0])                          //系统本周新增
			cveDB.Where("`fix_at` BETWEEN ? AND ?", curMon, curNow).Count(&count[1])                                                      //系统本周修复
			kernelDB.Where("`release` = 4.19  and `created_at` BETWEEN ? AND ?", curMon+" 00:00:00", curNow+" 23:59:59").Count(&count[2]) //内核本周新增
			kernelDB.Where("`release` = 4.19  and `fix_at` BETWEEN ? AND ?", curMon, curNow).Count(&count[4])                             //内核本周修复
		} else if strings.Contains(sort, "last") {
			lastMon, lastSun := utils.WeekDate(-1)                                                                                          //上周
			cveDB.Where("`created_at` BETWEEN ? AND ?", lastMon+" 00:00:00", lastSun+" 23:59:59").Count(&count[0])                          //系统上周新增
			cveDB.Where("`fix_at` BETWEEN ? AND ?", lastMon, lastSun).Count(&count[1])                                                      //系统上周修复
			kernelDB.Where("`release` = 4.19  and `created_at` BETWEEN ? AND ?", lastMon+" 00:00:00", lastSun+" 23:59:59").Count(&count[2]) //内核上周新增
			kernelDB.Where("`release` = 4.19  and `fix_at` BETWEEN ? AND ?", lastMon, lastSun).Count(&count[4])                             //内核上周修复
		}
	}
	return &count
}
